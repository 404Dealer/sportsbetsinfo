{% extends "base.html" %}

{% block content %}
<div class="games-page">
    <h1>Games</h1>
    <p class="page-subtitle">All games with snapshot history. Click to view belief drift timeline.</p>

    <div id="games-container" hx-get="/api/games" hx-trigger="load" hx-swap="innerHTML">
        <div class="loading">Loading games...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/games') {
        const data = JSON.parse(evt.detail.xhr.responseText);
        renderGames(data);
    }
});

function renderGames(data) {
    const container = document.getElementById('games-container');

    if (!data.games || data.games.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>No Games Yet</h3>
                <p>Collect game snapshots from the dashboard to see them here.</p>
            </div>
        `;
        return;
    }

    let html = `
        <div class="games-meta">
            <span><strong>${data.total}</strong> games tracked</span>
        </div>
        <table class="games-table">
            <thead>
                <tr>
                    <th>Game</th>
                    <th>Snapshots</th>
                    <th>Last Updated</th>
                    <th>Outcome</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
    `;

    for (const game of data.games) {
        const gameName = `${game.away_team || '?'} @ ${game.home_team || '?'}`;
        const lastUpdated = formatDateTime(game.last_snapshot);
        const outcome = game.has_outcome
            ? `<span class="outcome-badge">${game.winner} (${game.final_score})</span>`
            : '<span class="pending-badge">Pending</span>';

        html += `
            <tr class="game-row" onclick="window.location.href='/games/${game.game_id}'">
                <td class="game-name">${gameName}</td>
                <td class="snapshot-count">${game.snapshot_count}</td>
                <td class="last-updated">${lastUpdated}</td>
                <td class="outcome">${outcome}</td>
                <td class="view-link"><a href="/games/${game.game_id}">View Timeline &rarr;</a></td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString([], {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>
{% endblock %}
